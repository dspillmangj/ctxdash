name: Sync Dashboard Page to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC

jobs:
  sync-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install puppeteer@24.15.0 axios@1.7.7

      - name: Scrape dashboard page with scrape-key header
        env:
          SCRAPE_KEY: ${{ secrets.SCRAPE_KEY }}   # Same secret as your registration workflow
        run: |
          mkdir -p dist

          node -e "$(cat << 'EOF'
            const puppeteer = require('puppeteer');
            const axios = require('axios');
            const fs = require('fs').promises;
            const path = require('path');

            (async () => {
              const KEY = process.env.SCRAPE_KEY;
              if (!KEY) {
                console.error('SCRAPE_KEY secret is missing!');
                process.exit(1);
              }

              const browser = await puppeteer.launch({
                headless: 'new',
                args: ['--no-sandbox', '--disable-setuid-sandbox']
              });

              const page = await browser.newPage();

              // Critical: bypass Cloudflare
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36');
              await page.setExtraHTTPHeaders({
                'scrape-key': KEY
              });

              await page.setViewport({ width: 1280, height: 800 });

              const additionalAssets = [];

              await page.setRequestInterception(true);
              page.on('request', request => {
                const url = request.url();
                if (url.startsWith('https://ctxyouth.com/') &&
                    !url.includes('/feed/') &&
                    !url.includes('/wp-json/') &&
                    !url.includes('.php')) {
                  additionalAssets.push(url.split('?')[0]);
                }
                request.continue();
              });

              try {
                await page.goto('https://ctxyouth.com/dashboard', {
                  waitUntil: 'networkidle2',
                  timeout: 90000
                });
                await new Promise(r => setTimeout(r, 6000)); // Safe delay for dynamic content
              } catch (e) {
                console.error('Failed to load dashboard page:', e.message);
                await page.screenshot({ path: 'dist/error-dashboard.png', fullPage: true });
                throw e;
              }

              let content = await page.content();

              // Extract assets from DOM
              const domAssets = await page.evaluate(() => {
                const urls = [];
                const selectors = [
                  'link[href]', 'script[src]', 'img[src]', 'img[srcset]',
                  'source[src]', 'source[srcset]', '*[data-src]', '*[data-lazy-src]'
                ];
                selectors.forEach(sel => {
                  document.querySelectorAll(sel).forEach(el => {
                    const url = el.href || el.src || el.srcset || el.dataset.src || el.dataset.lazySrc;
                    if (url && url.startsWith('https://ctxyouth.com/') &&
                        !url.includes('/feed/') && !url.includes('/wp-json/')) {
                      urls.push(url.split('?')[0].split('#')[0]);
                    }
                  });
                });

                // CSS background images
                document.querySelectorAll('style, [style]').forEach(el => {
                  const text = (el.textContent || '') + (el.getAttribute('style') || '');
                  const matches = text.match(/url\(['"]?(https:\/\/ctxyouth\.com[^)'"]+)['"]?\)/gi);
                  if (matches) {
                    matches.forEach(m => {
                      const match = m.match(/https:\/\/ctxyouth\.com[^)'"]+/i);
                      if (match) urls.push(match[0].split('?')[0]);
                    });
                  }
                });

                return [...new Set(urls)];
              });

              const allAssets = [...new Set([...domAssets, ...additionalAssets])];
              console.log(`Found ${allAssets.length} assets to download`);

              // Download with retry + scrape-key header
              for (const assetUrl of allAssets) {
                const relativePath = assetUrl.replace('https://ctxyouth.com/', '').split('?')[0];
                const filePath = path.join('dist', relativePath);

                let downloaded = false;
                for (let i = 1; i <= 3; i++) {
                  try {
                    const response = await axios.get(assetUrl, {
                      responseType: 'arraybuffer',
                      timeout: 15000,
                      headers: { 'scrape-key': KEY }
                    });
                    await fs.mkdir(path.dirname(filePath), { recursive: true });
                    await fs.writeFile(filePath, response.data);
                    console.log(`Downloaded: ${relativePath}`);
                    downloaded = true;

                    // Rewrite URL in HTML
                    const escaped = assetUrl.split('?')[0].replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    content = content.replace(new RegExp(escaped, 'g'), `/${relativePath}`);
                    break;
                  } catch (err) {
                    if (i === 3) console.error(`Failed: ${assetUrl}`, err.message);
                    else await new Promise(r => setTimeout(r, 2000));
                  }
                }
              }

              // Final cleanup: replace any leftover absolute URLs
              content = content.replace(/https:\/\/ctxyouth\.com\//g, '/');

              await fs.writeFile('dist/index.html', content);
              console.log('Dashboard page scraped and saved to dist/index.html');
              await browser.close();
            })();
          EOF
          )"

      - name: Add CNAME file
        run: echo "dashboard.ctxyouth.com" > dist/CNAME

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist
          destination_dir: .
          keep_files: false
          commit_message: "Sync dashboard.ctxyouth.com - $(date +'%Y-%m-%d %H:%M') UTC"
